# deno and AWS Lambda

Using AWS Lambda custom runtime with deno.

We create a zip file which contains a bootstrap, the deno binary for Amazon Linux 1,
an entry point (`lambda.ts`) and any other files needed to run `lambda.ts`.

As a Handler we use exported async function `handler` inside `lambda.ts`.

_This follows the strategy from [Yoshiya Hinosawa's blogpost](https://dev.to/kt3k/write-aws-lambda-function-in-deno-4b20)._

## Download the deno binary from Amazon Linux

Temporarily here:
https://github.com/hayd/deno_docker/blob/releases/amz-deno-0.22.0

FIXME (hayd): Come up with a better way to deploy this (it should not be committed).

This is generated by running `amazonlinux-1.dockerfile`.

## Prepare zip file to upload to AWS Lambda

The fetch and DENO_DIR fiddling, whilst not strictly necessary,
ensures that deno doesn't need to either fetch source code or
compile it in order to run.

```
# fetch and compile your typescript file
DENO_DIR=.deno_dir deno fetch lambda.ts

# Files in DENO_DIR are full paths.
# We hide the $PWD and then undo this in bootstrap.
mv .deno_dir/gen/file/$PWD .deno_dir/LAMBDA_TASK_ROOT

# zip up the .deno_dir, amz-deno, bootstap and all your files.
zip -r lambda.zip .deno_dir amz-deno bootstrap lambda.ts

# undo the relative DENO_DIR hack
mkdir -p .deno_dir/gen/file$PWD
mv .deno_dir/LAMBDA_TASK_ROOT/* .deno_dir/gen/file/$PWD
```

## Create lambda function

### From [AWS console](https://console.aws.amazon.com/lambda/)

Create an AWS Lambda function. Choose "Author from scratch" and
as a runtime "Provide your own bootstrap".

Note: As a role "Create a new role with basic Lambda permissions" will usually
suffice, you can always add to it later.

Once created, in the "Function code" section change "Handler" from `hello.handler`
to `lambda.handler`. Save.

Now you can create and upload the zip file containing your runtime. Save.

### From CLI

TODO: make this clearer/simpler:

```
aws lambda create-function --function-name deno-func --zip-file fileb://lambda.zip --handler lambda.handler --runtime provided --role YOUR_ROLE
```

TODO: update

## Test

You can test from within the console, by selecting a sample test event or creating your own.
And clicking "Test".

From the CLI:

```
aws lambda invoke --function-name FUNCTION_NAME response.json && cat response.json
```

## TODO examples

- [ ] Web example (behind API Gateway).
