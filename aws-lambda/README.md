# deno and AWS Lambda

Using deno on AWS Lambda with a custom runtime.

## Quick Start

1. Download [deno-lambda-layer.zip]().
2. Create a new layer in AWS Lambda and upload that zip, note the ARN.
3. Create a lambda function from scratch, add the above ARN as a layer.
4. Create a file e.g. hello.ts which exports an async function handler:

```ts
// hello.ts

export async function handler(event, context) {
  return `Welcome to deno ${Deno.version.deno} ðŸ¦•`;
}
```
Save. And Test. Now you can amend your function in the AWS Lambda editor.

TODO: find commands for this. MAYBE should use an example.zip as the function (deno-lambda-example).

## Configurations on top of the deno-lambda-layer

Once your lambda function use the *deno-lambda-layer* it can be updated as usual.
Either in the editor or via CLI.

- Supports changing the handler file (must be .ts) and handler function.
- Supports setting the DENO_DIR for storing cached assets, default `.deno_dir`.

Further configuration TBD.

## Advanced

In order to create your own layer or custom runtime:

Create a zip file which contains
- bootstrap (found in this directory)
- the deno executable/binary for Amazon Linux 1 ([amz-deno]())
- an entry point which exports an async function (e.g. `hello.ts`)
- any other files needed to run the entry file
- .deno_dir directory\*

\*You can use a different directory by passing it as the DENO_DIR environment variable.

_This follows the strategy from [Yoshiya Hinosawa's blogpost](https://dev.to/kt3k/write-aws-lambda-function-in-deno-4b20)._

### Download the deno binary from Amazon Linux

Temporarily here:
https://github.com/hayd/deno_docker/blob/releases/amz-deno-0.22.0

FIXME (hayd): Come up with a better way to deploy this (it should not be committed).

This is generated by running `amazonlinux-1.dockerfile` and extracting it.

### Prepare zip file to upload to AWS Lambda

We zip up the binary and bootstrap files as well as the DENO_DIR.

If you are zipping up your function on top of the *deno-lambda-layer* then you should not
include those files, you need your source files and DENO_DIR.

Note: Including the DENO_DIR prevents runtime (actually "init-time") compilation,
but requires some fiddling to the directory layout. Specifically, the compiled
files are stored in your local $PWD rather than the lambda's $LAMBDA_TASK_ROOT,
so we rewrite some filenames to ensure we don't recompile.


```
# Compile the handler (and fetch dependencies into DENO_DIR).
DENO_DIR=.deno_dir deno fetch hello.ts
# Files in DENO_DIR are full paths.
# We move the local $PWD files and extract them in bootstrap.
rm -rf .deno_dir/LAMBDA_TASK_ROOT
cp -R .deno_dir/gen/file/$PWD/ .deno_dir/LAMBDA_TASK_ROOT

# If you are using deno-lambda-layer you only need your source files and DENO_DIR.
zip lambda.zip -x '.deno_dir/gen/file/*' -r .deno_dir hello.ts # etc.

# If not using a layer you'll need the bootstrap and amz-deno executable.
zip lambda.zip -x '.deno_dir/gen/file/*' -r .deno_dir amz-deno bootstrap hello.ts # etc.

# etc. being the other source files, perhaps *.ts ?
```
_TODO(hayd): write this as a deno script._

Note: If you use a different directory for your DENO_DIR you can do so,
but must set this as the DENO_DIR environment variable in the function.

## Examples

- [ ] Hello example (as a zip)
- [ ] Web example (behind API Gateway).


---



## Create lambda function

### From [AWS console](https://console.aws.amazon.com/lambda/)

Create an AWS Lambda function. Choose "Author from scratch" and
as a runtime "Provide your own bootstrap".

Note: As a role "Create a new role with basic Lambda permissions" will usually
suffice, you can always add to it later.

Once created, in the "Function code" section change "Handler" from `hello.handler`
to `lambda.handler`. Save.

Now you can create and upload the zip file containing your runtime. Save.

### From CLI

TODO: make this clearer/simpler (e.g. create role, IME using an existing role is a bad idea):

```
aws lambda create-function --function-name deno-func --zip-file fileb://lambda.zip --handler lambda.handler --runtime provided --role YOUR_ROLE
```

TODO: update

## Test

You can test from within the console, by selecting a sample test event or creating your own.
And clicking "Test".

From the CLI:

```
aws lambda invoke --function-name FUNCTION_NAME response.json && cat response.json
```

